
<link rel="stylesheet" href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css' crossorigin='anonymous'>
<script src='https://code.jquery.com/jquery-3.3.1.slim.min.js' crossorigin='anonymous'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js' crossorigin='anonymous'></script>
<script src='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js' crossorigin='anonymous'></script>
<link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css' type='text/css' rel='stylesheet'>
<script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

<!-- estilos del chat-->
<link rel="stylesheet" href='estilos-chat.css'>



    <html>
        <meta charset="utf-8">
    
        <div class="row pull-right">
            <button class="btn btn-info" onclick="enviarFinSesion()"> Fin de la Sesion</button>
        </div>

        <div class="row">
            
            <div class="col-md-2">
                <div class="list-group banner-usuarios" id="list-tab" role="tablist">
                    <a class="list-group-item list-group-item-action active" data-toggle="list" href="#chat_general" role="tab" aria-controls="home">Chat General</a>
                </div>
            </div>

            <div class="col-md-9">
                <nav>
                    <div class="nav nav-tabs nav-conversaciones" id="nav-tab" role="tablist">
                        <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#_chat_general" role="tab" aria-controls="_chat_general" aria-selected="true">Chat General</a>
                    </div>
                </nav>
                
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="_chat_general">

                        <div class="mesgs">
                            <div class="msg_history_chat_general" style='height: 516px; overflow-y: auto;'>
                            </div>

                            <div class="type_msg">
                                <div class="input_msg_write">
                                    <input id="chat_general" type="text" class="write_msg" placeholder="Type a message"/>
                                    <button class="msg_send_btn" type="button" onclick="enviarMensaje(this);"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
                                </div>
                            </div>
                        </div>

                        
                    </div>

                </div>
            </div>
        
        
                
        
        
        
        
        
        
        <script type="text/javascript" languaje="javascript">


            var clienteId = "Anele";
            var usuarios_activos = clienteId+"-";
            var conversaciones_activas = [];

            //Creo el mensaje que se va a enviar en caso de desconeccion abrupta
            var messageTestament = new Paho.MQTT.Message("Soy en usuario: "+clienteId + " y me estoy muriendo!");
            messageTestament.destinationName = "usuarios_inactivos";
            messageTestament.retained = false;


            // Create a client instance
            client = new Paho.MQTT.Client("localhost", Number("1884"), clienteId);

            // set callback handlers
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            // connect the client
            client.connect({onSuccess:onConnect});






            // called when the client connects
            function onConnect() {
                // Once a connection has been made, make a subscription and send a message.
                client.subscribe("conversaciones/#");
                client.subscribe("usuarios_activos");
                client.subscribe("usuarios_inactivos");

                //suscripcion a topico para cuando me llega una solicitud a unirme a algun chat
                client.subscribe(clienteId+"/notificaciones")

                setTimeout(function(){
                    unirmeAUsuariosEnVivo();
                },3000);

                
            }

            // called when the client loses its connection
            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("onConnectionLost:"+responseObject.errorMessage);
                }
            }

            // called when a message arrives
            function onMessageArrived(message) {
                
                //topico de usuarios en vivo
                if (message.destinationName == 'usuarios_activos'){
                    message.payloadString.split('-').forEach(element => {
                        if(!usuarios_activos.includes(element) && element != clienteId){
                            usuarios_activos = usuarios_activos + element + '-';
                            crearBannerNuevosUsuarios(element);
                        }
                    });
                    
                    console.log("luego de login usuarios activos tiene: "+usuarios_activos);
                }

                if (message.destinationName == 'usuarios_inactivos'){
                    console.log("debo borrar al usuario "+ message.payloadString)
                    message.payloadString.split('-').forEach(element => {
                        if(usuarios_activos.includes(element)){
                            usuarios_activos = usuarios_activos.replace(element+'-','');
                        }
                    });
                    console.log("luego de borrar usuarios activos tiene "+usuarios_activos)
                }


                if (message.destinationName == clienteId+"/notificaciones"){
                    //si alguien quiere chatear conmigo entonces automaticamente me uno al canal que recibo desde el
                    //y abro una nueva solapa de chat con el nombre del usuario que viene 
                    //y me suscribo a la la nueva sala de chat
                    stringConeccion = message.payloadString.split(":");
                    usuarioQueMeQuiereHablar = stringConeccion[0];
                    topicoRandom = stringConeccion[1];
                    alert("-----------");
                    alert(topicoRandom);
                    client.subscribe("conversaciones/"+topicoRandom) //tambien me suscribo yo al chat
                    crearNuevaVentanaDeConversacion(usuarioQueMeQuiereHablar, topicoRandom);  //iniciar una nueva ventana en algun lado con el id del topico
                    updateListaConversacionesIniciadas(usuarioQueMeQuiereHablar, topicoRandom);
                }


                if (message.destinationName.includes('conversaciones')){
                    topico = message.destinationName.split('/')[1];
                    console.log(topico);
                    appendNuevoMensaje(topico, message.payloadString);
                }

            }

            

            function unirmeAUsuariosEnVivo(){
                message = new Paho.MQTT.Message(usuarios_activos);
                message.retained = true;
                message.destinationName = "usuarios_activos";
                client.send(message);
            }


            function enviarFinSesion(){
                message = new Paho.MQTT.Message(clienteId);
                //message.retained = true;
                message.destinationName = "usuarios_inactivos";
                client.send(message);
            }


            function conversarConCliente(usuarioConElqueQuieroChatear){
                console.log("----------me llega--------------")
                //debe crear un nuevo topico (puede ser un numero aleatorio) y se lo envia al cliente con el que quiere chatear
                //mas precisamente a usuarioConElqueQuieroChatear/notificaciones

                //usuarioConElqueQuieroChatear = "Anele" //TODO recibir de algun lado este parametro
                random = Math.floor(Math.random() * 101).toString(); //te da un numero random entre 0 y 101
                topicoRandom = random;
                msg = clienteId+":"+topicoRandom; //el mensaje es ClienteQueIniciaChat:nÂ°random de chat
                message = new Paho.MQTT.Message(msg);
                message.destinationName = usuarioConElqueQuieroChatear+"/notificaciones";
                client.send(message);    
                client.subscribe(topicoRandom) //tambien me suscribo yo al chat
                crearNuevaVentanaDeConversacion(usuarioConElqueQuieroChatear, random);  //iniciar una nueva ventana en algun lado con el id del topico
                updateListaConversacionesIniciadas(usuarioConElqueQuieroChatear, random);

            }

            //<a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">TODOS</a>


            function crearNuevaVentanaDeConversacion(nombreUsuario, topico){
                
                //TODO si ya esta abierta una conversacion que la reutilice.

                $('.nav-conversaciones').append("<a class='nav-item nav-link' data-toggle='tab' href='#_"+topico+
                                                "' role='tab' aria-controls='_"+topico+
                                                "'>"+nombreUsuario+"</a>");

                $('#nav-tabContent').append("<div class='tab-pane fade show' id='_"+topico+"'>"+
                                                "<div class='mesgs'>\
                                                    <div class='msg_history_"+topico+"' style='height: 516px; overflow-y: auto;'>\
                                                    </div>\
                                                    <div class='type_msg' style='background-color: white;'>\
                                                        <div class='input_msg_write'>\
                                                            <input id='"+topico+"' type='text' class='write_msg' placeholder='Type a message' />\
                                                            <button class='msg_send_btn' type='button' onclick='enviarMensaje(this);'><i class='fa fa-paper-plane-o' aria-hidden='true'></i></button>\
                                                        </div>\
                                                    </div>\
                                                </div>\
                                            </div>")
            }



            function crearBannerNuevosUsuarios(usuario){
                /*
                usuarios_activos.split('-').forEach(element => {
                    if (!$(".banner-usuarios").html().includes(element)){
                        $(".banner-usuarios").append("<a class='list-group-item list-group-item-action'data-toggle='list' href='#' onclick='conversarConCliente(this.id)' role='tab' aria-controls='home' id="+element+">"+ element+"</a>");
                    }
                });
                */
                if (!$(".banner-usuarios").html().includes(usuario)){
                    $(".banner-usuarios").append("<a class='list-group-item list-group-item-action'data-toggle='list' href='#' onclick='conversarConCliente(this.id)' role='tab' aria-controls='home' id="+usuario+">"+ usuario+"</a>");
                }
            }
            

            function updateListaConversacionesIniciadas(username, id_topico){
                // TODO: primero buscar antes de insertar
                conversaciones_activas.push({
                    key : username,
                    value: id_topico
                })
            }


            function enviarMensaje(boton){
                topico = $(boton).prev()[0].id; 
                mensaje = clienteId+":"+ $(boton).prev()[0].value;
                $($(boton).prev()[0]).val('');
                //appendNuevoMensaje(topico, clienteId) //NO VA ACA, VA EN RECIBIR
                message = new Paho.MQTT.Message(mensaje);
                alert(topico);
                message.destinationName = "conversaciones/"+topico;
                client.send(message);
            }


            function appendNuevoMensaje(topico, mensaje){
                usuarioQueEnviaMsg = mensaje.split(":")[0];
                msg = mensaje.split(":")[1];
                if (usuarioQueEnviaMsg == clienteId){
                    $(".msg_history_"+topico).append("<div class='outgoing_msg'>\
                                                        <div class='sent_msg'>\
                                                            <p>'"+msg+"'</p>\
                                                        </div>");
                }
                else{
                    $(".msg_history_"+topico).append("<div class='incoming_msg'>\
                                                        <div class='incoming_msg_img'>\
                                                        <img src='https://ptetutorials.com/images/user-profile.png' alt='sunil'> </div>\
                                                        <div class='received_msg'>\
                                                            <div class='received_withd_msg'>\
                                                            <p>'"+msg+"'</p>\
                                                            <span class='time_date'></span></div>\
                                                        </div>\
                                                        </div>");
                }
            }
        </script>
</html>