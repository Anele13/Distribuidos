<link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css' integrity='sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T' crossorigin='anonymous'>
<script src='https://code.jquery.com/jquery-3.3.1.slim.min.js' integrity='sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo' crossorigin='anonymous'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js' integrity='sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1' crossorigin='anonymous'></script>
<script src='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js' integrity='sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM' crossorigin='anonymous'></script>
<link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css' type='text/css' rel='stylesheet'>
<script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>"


<html>
        <button class="btn btn-info" onclick="enviarFinSesion()"> Fin de la Sesion</button>
        <meta charset="utf-8">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
        
        <script type="text/javascript" languaje="javascript">


            var clienteId = "Pepe";
            var usuarios_activos = clienteId+"-";

            //Creo el mensaje que se va a enviar en caso de desconeccion abrupta
            var messageTestament = new Paho.MQTT.Message("Soy en usuario: "+clienteId + " y me estoy muriendo!");
            messageTestament.destinationName = "usuarios_inactivos";
            messageTestament.retained = true;


            // Create a client instance
            client = new Paho.MQTT.Client("localhost", Number("1884"), clienteId);

            // set callback handlers
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            // connect the client
            client.connect({onSuccess:onConnect});






            // called when the client connects
            function onConnect() {
                // Once a connection has been made, make a subscription and send a message.
                client.subscribe("chat_general");
                client.subscribe("usuarios_activos");
                client.subscribe("usuarios_inactivos");

                setTimeout(function(){
                    unirmeAUsuariosEnVivo();
                },3000);

                
            }

            // called when the client loses its connection
            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("onConnectionLost:"+responseObject.errorMessage);
                }
            }

            // called when a message arrives
            function onMessageArrived(message) {
                
                //topico de usuarios en vivo
                if (message.destinationName == 'usuarios_activos'){
                    message.payloadString.split('-').forEach(element => {
                        if(!usuarios_activos.includes(element)){
                            usuarios_activos = usuarios_activos + element + '-';
                        }
                    });
                    console.log("luego de login usuarios activos tiene: "+usuarios_activos);
                }

                if (message.destinationName == 'usuarios_inactivos'){
                    console.log("debo borrar al usuario "+ message.payloadString)
                    message.payloadString.split('-').forEach(element => {
                        if(usuarios_activos.includes(element)){
                            usuarios_activos = usuarios_activos.replace(element+'-','');
                        }
                    });
                    console.log("luego de borrar usuarios activos tiene "+usuarios_activos)
                }

                if (message.destinationName == 'chat_general'){
                    console.log("Mensaje para todos los usuarios del chart general "+ message.payloadString)
                }
            }

            function unirmeAUsuariosEnVivo(){
                message = new Paho.MQTT.Message(usuarios_activos);
                message.retained = true;
                message.destinationName = "usuarios_activos";
                client.send(message);
            }

            function enviarFinSesion(){
                message = new Paho.MQTT.Message(clienteId);
                //message.retained = true;
                message.destinationName = "usuarios_inactivos";
                client.send(message);
            }
                    
        </script>
</html>